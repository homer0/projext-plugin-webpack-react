<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/plugin.js | projext-plugin-webpack-react</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Allows you to bundle a React project with projext using the webpack build engine."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="projext-plugin-webpack-react"><meta property="twitter:description" content="Allows you to bundle a React project with projext using the webpack build engine."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/homer0/projext-plugin-webpack-react"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugin.js~ProjextReactPlugin.html">ProjextReactPlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://homer0.github.io/projext/class/src/app/index.js~Projext.html">Projext</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/plugin.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * It updates targets Babel configuration in order to add support for JSX and hot reload.
 */
class ProjextReactPlugin {
  /**
   * Class constructor.
   */
  constructor() {
    /**
     * The name of the reducer event the service will listen for in order to exclude React packages
     * from the bundle when the target is for Node or it&apos;s a browser library.
     * @type {string}
     * @access protected
     * @ignore
     */
    this._externalSettingsEventName = &apos;webpack-externals-configuration&apos;;
    /**
     * The list of React packages that should never end up on the bundle. For browser targets,
     * this is only added if the target is also a library.
     * @type {Array}
     * @access protected
     * @ignore
     */
    this._externalModules = [
      &apos;react&apos;,
      &apos;react-dom&apos;,
      &apos;react-dom/server&apos;,
    ];
    /**
     * The name of the reducer event the service will listen for in order to add support for JSX
     * and HMR.
     * @type {string}
     * @access protected
     * @ignore
     */
    this._babelConfigurationEvent = &apos;babel-configuration&apos;;
    /**
     * The name of the Babel preset required to add support for React&apos;s JSX.
     * @type {string}
     * @access protected
     * @ignore
     */
    this._babelPreset = &apos;@babel/preset-react&apos;;
    /**
     * The name of the plugin required for HMR.
     * @type {string}
     * @access protected
     * @ignore
     */
    this._babelHotPlugin = &apos;react-hot-loader/babel&apos;;
    /**
     * The name of the reducer event the service will listen for in order to update a target entry
     * settings when the target implements HMR.
     * @type {string}
     * @access protected
     * @ignore
     */
    this._targetEntriesEvent = &apos;webpack-browser-development-configuration&apos;;
    /**
     * The name of the required entry in order to enable HMR.
     * @type {string}
     * @access protected
     * @ignore
     */
    this._hotEntry = &apos;react-hot-loader/patch&apos;;
    /**
     * The required value a target `framework` setting needs to have in order for the service to
     * take action.
     * @type {string}
     * @access protected
     * @ignore
     */
    this._frameworkProperty = &apos;react&apos;;
  }
  /**
   * This is the method called when the plugin is loaded by projext. It setups all the listeners
   * for the events the plugin needs to intercept in order to add support for JSX.
   * It also listens for the event that defines the external dependencies, because if the
   * target type is Node or is a library, it should include the React packages as externals.
   * @param {Projext} app The projext main container.
   */
  register(app) {
    // Get the `events` service to listen for the events.
    const events = app.get(&apos;events&apos;);
    // Get the `babelHelper` to send to the method that updates the Babel configuration.
    const babelHelper = app.get(&apos;babelHelper&apos;);
    // Add the listener for the event that updates the Babel configuration.
    events.on(this._babelConfigurationEvent, (configuration, target) =&gt; (
      this._updateBabelConfiguration(configuration, target, babelHelper)
    ));
    // Add the listener for the event that updates the target entries.
    events.on(this._targetEntriesEvent, (config, params) =&gt; (
      this._updateTargetEntry(config, params.target)
    ));
    // Add the listener for the event that updates the external dependencies.
    events.on(this._externalSettingsEventName, (externals, params) =&gt; (
      this._updateExternals(externals, params.target)
    ));
  }
  /**
   * This method gets called when projext reduces a target Babel configuration. The method will
   * validate the target settings and add the Babel plugins needed for JSX and HMR.
   * @param {Object}      currentConfiguration The current Babel configuration for the target.
   * @param {Target}      target               The target information.
   * @param {BabelHelper} babelHelper          To update the target configuration and add the
   *                                           required preset and plugin.
   * @return {Object} The updated configuration.
   * @access protected
   * @ignore
   */
  _updateBabelConfiguration(currentConfiguration, target, babelHelper) {
    let updatedConfiguration;
    if (target.framework === this._frameworkProperty) {
      updatedConfiguration = babelHelper.addPreset(currentConfiguration, this._babelPreset);
      if (target.hot) {
        updatedConfiguration = babelHelper.addPlugin(updatedConfiguration, this._babelHotPlugin);
        updatedConfiguration = babelHelper.disableEnvPresetModules(updatedConfiguration);
      }
    } else {
      updatedConfiguration = currentConfiguration;
    }

    return updatedConfiguration;
  }
  /**
   * This method gets called when projext reduces a target configuration for Wepack. It validates
   * the target settings and if HMR is enabled, it updates the `entry` setting with the required
   * changes for the React Hot Loader.
   * @param {Object} currentConfiguration The current configuration for the target.
   * @param {Target} target               The target information.
   * @return {Object} The updated configuration.
   * @access protected
   * @ignore
   */
  _updateTargetEntry(currentConfiguration, target) {
    let updatedConfiguration;
    // If the target `framework` and `hot` have the required values...
    if (target.framework === this._frameworkProperty &amp;&amp; target.hot) {
      // Copy the configuration.
      updatedConfiguration = Object.assign({}, currentConfiguration);
      // Update the `publicPath`, required by the loader.
      updatedConfiguration.output.publicPath = &apos;/&apos;;
      // Get target entry name.
      const [entryName] = Object.keys(updatedConfiguration.entry);
      // Get the list of entries for the target.
      const entries = updatedConfiguration.entry[entryName];
      // Check if the `babel-polyfill` is present, since it always needs to be first.
      const polyfillIndex = entries.indexOf(&apos;babel-polyfill&apos;);
      // If the `babel-polyfill` is present...
      if (polyfillIndex &gt; -1) {
        // ...push the required entry after it.
        entries.splice(polyfillIndex + 1, 0, this._hotEntry);
      } else {
        // ...push the required entry as the first item.
        entries.unshift(this._hotEntry);
      }
    } else {
      // ...otherwise, just set to return the received configuration.
      updatedConfiguration = currentConfiguration;
    }

    return updatedConfiguration;
  }
  /**
   * This method gets called when the webpack plugin reduces the list of modules that should be
   * handled as external dependencies. The method validates the target settings and if it&apos;s a
   * Node target or a browser library, it pushes the React packages to the list.
   * @param {Object} currentExternals A dictionary of external dependencies with the format
   *                                  webpack uses: `{ &apos;module&apos;: &apos;commonjs module&apos;}`.
   * @param {Target} target           The target information.
   * @return {Object} The updated externals dictionary.
   * @access protected
   * @ignore
   */
  _updateExternals(currentExternals, target) {
    let updatedExternals;
    if (
      target.framework === this._frameworkProperty &amp;&amp;
      (target.is.node || target.library)
    ) {
      updatedExternals = Object.assign({}, currentExternals);
      this._externalModules.forEach((name) =&gt; {
        updatedExternals[name] = `commonjs ${name}`;
      });
    } else {
      updatedExternals = currentExternals;
    }

    return updatedExternals;
  }
}

module.exports = ProjextReactPlugin;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
